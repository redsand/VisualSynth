<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VisualSynth</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <header class="top-bar">
        <div class="brand">
          <img
            class="brand-logo"
            src="visualsynth_logo-transparent.png"
            alt="VisualSynth"
          />
        </div>
        <div class="top-controls">
          <div id="mode-switcher" class="mode-switcher">
            <button type="button" class="mode-button active" data-mode="performance">Performance</button>
            <button type="button" class="mode-button" data-mode="mixer">Mixer</button>
            <button type="button" class="mode-button" data-mode="mapping">Mapping</button>
            <div class="mode-separator"></div>
            <button type="button" class="mode-button secondary-mode" data-mode="scene">Design</button>
            <button type="button" class="mode-button secondary-mode" data-mode="system">System</button>
          </div>
          <div class="transport">
            <label class="transport-label">
              BPM
              <input id="transport-bpm" type="number" min="40" max="240" step="1" value="120" />
            </label>
            <button type="button" id="transport-tap">Tap</button>
            <button type="button" id="transport-pause">Pause</button>
          </div>
          <label class="output-route">
            Output
            <select id="output-route">
              <option value="preview" selected>Preview</option>
              <option value="output">Output</option>
            </select>
          </label>
          <label class="visual-mode-route">
            Visual Mode
            <select id="visual-mode-select">
              <option value="mode-cosmic">Cosmic</option>
              <option value="mode-ignite">Ignite</option>
              <option value="mode-minimal">Minimal</option>
              <option value="mode-acid">Acid</option>
            </select>
          </label>
          <label class="engine-route">
            Visual Engine
            <select id="engine-select">
              <option value="engine-radial-core">Radial Energy Core</option>
              <option value="engine-particle-flow">Particle Flow Field</option>
              <option value="engine-kaleido-pulse">Kaleidoscopic Pulse</option>
              <option value="engine-vapor-grid">Vapor Grid Shift</option>
            </select>
          </label>
          <div class="health-strip">
            <span id="health-fps">FPS: --</span>
            <span id="health-latency">Latency: --</span>
            <span id="health-watchdog">Watchdog: OK</span>
          </div>
          <div class="summary-chips">
            <button type="button" id="summary-mods" class="summary-chip hidden" data-mode="design">Mods: 0</button>
            <button type="button" id="summary-fx" class="summary-chip hidden" data-mode="design">FX: Off</button>
            <button type="button" id="summary-auto" class="summary-chip hidden" data-mode="scene">Auto: 0</button>
          </div>
        </div>
      </header>

      <div id="scene-timeline" class="scene-timeline">
        <div class="scene-timeline-header">
          <span>Scene Timeline</span>
          <span id="scene-timeline-status" class="scene-timeline-status">Active: --</span>
        </div>
        <div id="scene-timeline-track" class="scene-timeline-track"></div>
      </div>
<main class="layout">
<section class="left-panel">
          <div id="mode-performance-left" class="mode-pane">
            <h2>Performance</h2>
            <div id="engine-description" class="engine-description">Select an engine to begin...</div>
            <div id="scene-strip" class="panel-block scene-strip">
              <div class="scene-strip-header">
                <h3>Scene Strip</h3>
                <div class="scene-strip-controls">
                  <span class="scene-strip-label">View</span>
                  <button type="button" class="scene-strip-toggle active" data-scene-view="cards">Cards</button>
                  <button type="button" class="scene-strip-toggle" data-scene-view="list">List</button>
                </div>
              </div>
              <label class="scene-label">
                Active Scene
                <select id="scene-select"></select>
              </label>
              <label class="scene-label">
                Quantize
                <select id="quantize-select">
                  <option value="quarter">1/4</option>
                  <option value="half">1/2</option>
                  <option value="bar" selected>1 Bar</option>
                </select>
              </label>
              <div class="scene-row">
                <button id="queue-scene">Queue</button>
                <button id="activate-scene" type="button">Activate</button>
              </div>
              <div id="bpm-display" class="bpm-display">BPM: --</div>
              <div id="scene-strip-cards" class="scene-strip-cards"></div>
              <div id="scene-strip-list" class="scene-strip-list hidden"></div>
              <div class="scene-strip-add">
                <button id="scene-add-blank" type="button">New Blank Scene</button>
              </div>
            </div>
            <div class="panel-block">
              <h3>Performance Mixer</h3>
              <div class="scene-row">
                <label class="scene-inline">
                  Core
                  <div class="mixer-meter-container mini-meter"><div id="perf-meter-core" class="mixer-meter-fill"></div></div>
                  <input id="mix-role-core" type="range" min="0" max="2" step="0.05" value="1" />
                </label>
                <label class="scene-inline">
                  Support
                  <div class="mixer-meter-container mini-meter"><div id="perf-meter-support" class="mixer-meter-fill"></div></div>
                  <input id="mix-role-support" type="range" min="0" max="2" step="0.05" value="1" />
                </label>
                <label class="scene-inline">
                  Atmosphere
                  <div class="mixer-meter-container mini-meter"><div id="perf-meter-atmosphere" class="mixer-meter-fill"></div></div>
                  <input id="mix-role-atmosphere" type="range" min="0" max="2" step="0.05" value="1" />
                </label>
              </div>
              <div class="output-hint">Global intensity multipliers per visual role.</div>
            </div>
            <div class="panel-block" id="preset-explorer">
              <h3>Preset Explorer</h3>
              <label class="scene-label">
                Preset
                <select id="preset-select"></select>
              </label>
              <div class="scene-row">
                <label class="scene-inline">
                  Category
                  <select id="preset-category"></select>
                </label>
                <button id="preset-shuffle" type="button">Shuffle</button>
              </div>
              <div class="scene-row">
                <button id="preset-prev" type="button">Previous</button>
                <button id="preset-next" type="button">Next</button>
                <button id="btn-apply-preset" type="button">Add Preset as Scene</button>
              </div>
              <div id="preset-browser" class="preset-browser"></div>
            </div>
            <div class="panel-block">
              <h3>64-Pad Performance</h3>
              <div class="bank-row" id="pad-bank">
                <button type="button" data-bank="A" class="bank-button active">A</button>
                <button type="button" data-bank="B" class="bank-button">B</button>
                <button type="button" data-bank="C" class="bank-button">C</button>
                <button type="button" data-bank="D" class="bank-button">D</button>
              </div>
              <div id="pad-grid" class="pad-grid"></div>
              <div class="pad-hint">Pads 0-31 toggle plasma layer. Pads 32-63 trigger strobe.</div>
            </div>
            <div class="panel-block">
              <h3>Quick Toggles</h3>
              <label class="scene-label">
                <input type="checkbox" id="perf-toggle-spectrum" checked /> Spectrum Bars
              </label>
              <label class="scene-label">
                <input type="checkbox" id="perf-toggle-plasma" checked /> Plasma Layer
              </label>
              <div id="spectrum-hint" class="hint">
                These bars are the Spectrum layer. Toggle off to hide them.
                <button id="spectrum-hint-dismiss" type="button">Got it</button>
              </div>
            </div>
            <div class="panel-block">
              <h3>Add Layers</h3>
              <div class="scene-row">
                <button id="perf-add-layer" type="button">Add Layer...</button>
              </div>
              <div class="output-hint">Opens Scene mode Generator Library.</div>
            </div>
            <div class="panel-block">
              <h3>Layer Quick Controls</h3>
              <div class="layer-list" id="layer-list"></div>
            </div>
          </div>

          <div id="mode-scene-left" class="mode-pane hidden">
            <h2>Scene</h2>
            <div id="scene-strip-anchor"></div>
            <div class="panel-block">
              <h3>Layers</h3>
              <div class="layer-list" id="layer-list-scene"></div>
            </div>
            <div class="panel-block" id="generator-panel">
              <h3>Generator Library</h3>
              <label class="scene-label">
                Add Generator
                <select id="generator-select"></select>
              </label>
              <button id="generator-add">Add Generator</button>
              <div class="generator-section">
                <div class="generator-title">Favorites</div>
                <div id="generator-favorites" class="generator-list"></div>
              </div>
              <div class="generator-section">
                <div class="generator-title">Recent</div>
                <div id="generator-recents" class="generator-list"></div>
              </div>
            </div>
            <div class="panel-block">
              <h3>Preset Exchange</h3>
              <div class="scene-row">
                <button id="export-scene">Export Scene</button>
                <button id="import-scene">Import Scene</button>
              </div>
              <div class="scene-row">
                <button id="export-macros">Export Macros</button>
                <button id="import-macros">Import Macros</button>
              </div>
            </div>
          </div>

          <div id="mode-mixer-left" class="mode-pane hidden">
            <h2>Mixer</h2>
            <div id="mixer-panel-anchor" class="mixer-panel-container">
              <!-- Mixer UI injected here -->
            </div>
          </div>

          <div id="mode-design-left" class="mode-pane hidden">
            <h2>Design</h2>
            <div class="panel-block">
              <h3>Layer Effects</h3>
              <label class="scene-label scene-label-inline">
                <input type="checkbox" id="effects-enabled" checked /> Enable Effects
              </label>
              <div class="scene-row">
                <label class="scene-inline">
                  Bloom
                  <input id="effect-bloom" type="range" min="0" max="1" step="0.05" value="0.2" />
                </label>
                <label class="scene-inline">
                  Blur
                  <input id="effect-blur" type="range" min="0" max="1" step="0.05" value="0" />
                </label>
                <label class="scene-inline">
                  Chromatic
                  <input id="effect-chroma" type="range" min="0" max="0.5" step="0.02" value="0.1" />
                </label>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Posterize
                  <input id="effect-posterize" type="range" min="0" max="1" step="0.05" value="0" />
                </label>
                <label class="scene-inline">
                  Kaleidoscope
                  <input id="effect-kaleidoscope" type="range" min="0" max="1" step="0.05" value="0" />
                </label>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Feedback
                  <input id="effect-feedback" type="range" min="0" max="1" step="0.05" value="0" />
                </label>
                <label class="scene-inline">
                  Persistence
                  <input id="effect-persistence" type="range" min="0" max="1" step="0.05" value="0" />
                </label>
              </div>
            </div>
            <div class="panel-block">
              <h3>Expressive FX</h3>
              <div class="expressive-item">
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-energy-enabled" /> Energy Bloom
                  </label>
                  <label class="scene-inline">
                    Macro
                    <input id="expressive-energy-macro" type="range" min="0" max="1" step="0.05" value="0.35" />
                  </label>
                </div>
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-energy-intent-enabled" /> Bind Intent
                  </label>
                  <label class="scene-inline">
                    Intent
                    <select id="expressive-energy-intent">
                      <option value="calm">Calm</option>
                      <option value="pulse">Pulse</option>
                      <option value="build">Build</option>
                      <option value="chaos">Chaos</option>
                      <option value="ambient" selected>Ambient</option>
                    </select>
                  </label>
                  <label class="scene-inline">
                    Amount
                    <input id="expressive-energy-intent-amount" type="range" min="0" max="1" step="0.05" value="0.35" />
                  </label>
                </div>
                <details class="expert-panel">
                  <summary>Expert</summary>
                  <div class="scene-row">
                    <label class="scene-inline">
                      Threshold
                      <input id="expressive-energy-threshold" type="range" min="0" max="1" step="0.05" value="0.55" />
                    </label>
                    <label class="scene-inline">
                      Accumulation
                      <input id="expressive-energy-accumulation" type="range" min="0" max="1" step="0.05" value="0.65" />
                    </label>
                  </div>
                </details>
              </div>
              <div class="expressive-item">
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-radial-enabled" /> Radial Gravity
                  </label>
                  <label class="scene-inline">
                    Macro
                    <input id="expressive-radial-macro" type="range" min="0" max="1" step="0.05" value="0.3" />
                  </label>
                </div>
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-radial-intent-enabled" /> Bind Intent
                  </label>
                  <label class="scene-inline">
                    Intent
                    <select id="expressive-radial-intent">
                      <option value="calm">Calm</option>
                      <option value="pulse">Pulse</option>
                      <option value="build">Build</option>
                      <option value="chaos">Chaos</option>
                      <option value="ambient" selected>Ambient</option>
                    </select>
                  </label>
                  <label class="scene-inline">
                    Amount
                    <input id="expressive-radial-intent-amount" type="range" min="0" max="1" step="0.05" value="0.35" />
                  </label>
                </div>
                <details class="expert-panel">
                  <summary>Expert</summary>
                  <div class="scene-row">
                    <label class="scene-inline">
                      Strength
                      <input id="expressive-radial-strength" type="range" min="0" max="1" step="0.05" value="0.6" />
                    </label>
                    <label class="scene-inline">
                      Radius
                      <input id="expressive-radial-radius" type="range" min="0" max="1" step="0.05" value="0.65" />
                    </label>
                  </div>
                  <div class="scene-row">
                    <label class="scene-inline">
                      Focus X
                      <input id="expressive-radial-focus-x" type="range" min="0" max="1" step="0.05" value="0.5" />
                    </label>
                    <label class="scene-inline">
                      Focus Y
                      <input id="expressive-radial-focus-y" type="range" min="0" max="1" step="0.05" value="0.5" />
                    </label>
                  </div>
                </details>
              </div>
              <div class="expressive-item">
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-echo-enabled" /> Motion Echo
                  </label>
                  <label class="scene-inline">
                    Macro
                    <input id="expressive-echo-macro" type="range" min="0" max="1" step="0.05" value="0.3" />
                  </label>
                </div>
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-echo-intent-enabled" /> Bind Intent
                  </label>
                  <label class="scene-inline">
                    Intent
                    <select id="expressive-echo-intent">
                      <option value="calm">Calm</option>
                      <option value="pulse">Pulse</option>
                      <option value="build">Build</option>
                      <option value="chaos">Chaos</option>
                      <option value="ambient" selected>Ambient</option>
                    </select>
                  </label>
                  <label class="scene-inline">
                    Amount
                    <input id="expressive-echo-intent-amount" type="range" min="0" max="1" step="0.05" value="0.35" />
                  </label>
                </div>
                <details class="expert-panel">
                  <summary>Expert</summary>
                  <div class="scene-row">
                    <label class="scene-inline">
                      Decay
                      <input id="expressive-echo-decay" type="range" min="0" max="1" step="0.05" value="0.6" />
                    </label>
                    <label class="scene-inline">
                      Warp
                      <input id="expressive-echo-warp" type="range" min="0" max="1" step="0.05" value="0.35" />
                    </label>
                  </div>
                </details>
              </div>
              <div class="expressive-item">
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-smear-enabled" /> Spectral Smear
                  </label>
                  <label class="scene-inline">
                    Macro
                    <input id="expressive-smear-macro" type="range" min="0" max="1" step="0.05" value="0.3" />
                  </label>
                </div>
                <div class="scene-row">
                  <label class="scene-inline">
                    <input type="checkbox" id="expressive-smear-intent-enabled" /> Bind Intent
                  </label>
                  <label class="scene-inline">
                    Intent
                    <select id="expressive-smear-intent">
                      <option value="calm">Calm</option>
                      <option value="pulse">Pulse</option>
                      <option value="build">Build</option>
                      <option value="chaos">Chaos</option>
                      <option value="ambient" selected>Ambient</option>
                    </select>
                  </label>
                  <label class="scene-inline">
                    Amount
                    <input id="expressive-smear-intent-amount" type="range" min="0" max="1" step="0.05" value="0.35" />
                  </label>
                </div>
                <details class="expert-panel">
                  <summary>Expert</summary>
                  <div class="scene-row">
                    <label class="scene-inline">
                      Offset
                      <input id="expressive-smear-offset" type="range" min="0" max="1" step="0.05" value="0.4" />
                    </label>
                    <label class="scene-inline">
                      Mix
                      <input id="expressive-smear-mix" type="range" min="0" max="1" step="0.05" value="0.6" />
                    </label>
                  </div>
                </details>
              </div>
            </div>
            <div class="panel-block">
              <h3>Color Palette</h3>
              <label class="scene-label">
                Palette
                <select id="palette-select"></select>
              </label>
              <label class="scene-label">
                Chemistry
                <select id="chemistry-select">
                  <option value="analog">Analog (Smooth)</option>
                  <option value="triadic">Triadic (Balanced)</option>
                  <option value="complementary">Complementary (Contrast)</option>
                  <option value="monochromatic">Monochromatic (Single)</option>
                </select>
              </label>
              <div id="palette-preview" class="palette-preview"></div>
              <label class="scene-label scene-label-inline">
                <input type="checkbox" id="palette-apply-scene" /> Apply to Scene Look
              </label>
            </div>
            <div class="panel-block">
              <h3>Particle Field</h3>
              <label class="scene-label scene-label-inline">
                <input type="checkbox" id="particles-enabled" checked /> Enable Particles
              </label>
              <div class="scene-row">
                <label class="scene-inline">
                  Density
                  <input id="particles-density" type="range" min="0" max="1" step="0.05" value="0.35" />
                </label>
                <label class="scene-inline">
                  Speed
                  <input id="particles-speed" type="range" min="0" max="1" step="0.05" value="0.3" />
                </label>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Size
                  <input id="particles-size" type="range" min="0" max="1" step="0.05" value="0.45" />
                </label>
                <label class="scene-inline">
                  Glow
                  <input id="particles-glow" type="range" min="0" max="1" step="0.05" value="0.6" />
                </label>
                <label class="scene-inline">
                  Turbulence
                  <input id="particles-turbulence" type="range" min="0" max="1" step="0.05" value="0.3" />
                </label>
                <label class="scene-inline">
                  Audio Lift
                  <input id="particles-audio-lift" type="range" min="0" max="1" step="0.05" value="0.5" />
                </label>
              </div>
            </div>
            <div class="panel-block">
              <h3>SDF Shapes</h3>
              <label class="scene-label scene-label-inline">
                <input type="checkbox" id="sdf-enabled" checked /> Enable SDF
              </label>
              <label class="scene-label scene-label-inline">
                <input type="checkbox" id="sdf-advanced-enabled" /> Use Advanced Node Scene
              </label>
              <div id="sdf-simple-controls">
                <label class="scene-label">
                  Shape
                  <select id="sdf-shape">
                    <option value="circle">Circle</option>
                    <option value="box">Box</option>
                    <option value="triangle">Triangle</option>
                    <option value="hexagon">Hexagon</option>
                    <option value="star">Star</option>
                    <option value="ring">Ring</option>
                  </select>
                </label>
                <div class="scene-row">
                  <label class="scene-inline">
                    Scale
                    <input id="sdf-scale" type="range" min="0" max="1" step="0.05" value="0.45" />
                  </label>
                  <label class="scene-inline">
                    Rotation
                    <input id="sdf-rotation" type="range" min="-3.14" max="3.14" step="0.05" value="0" />
                  </label>
                </div>
                <div class="scene-row">
                  <label class="scene-inline">
                    Edge
                    <input id="sdf-edge" type="range" min="0" max="0.5" step="0.02" value="0.08" />
                  </label>
                  <label class="scene-inline">
                    Glow
                    <input id="sdf-glow" type="range" min="0" max="1" step="0.05" value="0.5" />
                  </label>
                </div>
                <div class="scene-row">
                  <label class="scene-inline">
                    Fill
                    <input id="sdf-fill" type="range" min="0" max="1" step="0.05" value="0.35" />
                  </label>
                  <label class="scene-inline">
                    Color
                    <input id="sdf-color" type="color" value="#ff9940" />
                  </label>
                </div>
              </div>
              <div id="sdf-editor" class="sdf-editor hidden">
                <!-- Advanced Editor injected here -->
              </div>
            </div>
          </div>

          <div id="mode-mapping-left" class="mode-pane hidden">
            <h2>Mapping</h2>
            <div class="panel-block">
              <div class="output-hint">Drag a Source to any parameter to create a mapping.</div>
            </div>
            <div id="mapping-sources-anchor" class="panel-block">
              <h3>Sources</h3>
              <!-- Reactive sources list -->
            </div>
          </div>

          <div id="mode-system-left" class="mode-pane hidden">
            <h2>System</h2>
            <div class="panel-block">
              <h3>Devices</h3>
              <label class="scene-label">
                Audio Input
                <select id="audio-device"></select>
              </label>
              <label class="scene-label">
                MIDI Input
                <select id="midi-device"></select>
              </label>
              <button id="toggle-midi">Enable MIDI</button>
            </div>
            <div class="panel-block">
              <h3>Beat Tuning</h3>
              <div class="scene-row">
                <label class="scene-inline">
                  Sensitivity
                  <input id="beat-sensitivity" type="range" min="0.5" max="4" step="0.1" value="1.5" />
                </label>
                <label class="scene-inline">
                  Onset Filter
                  <select id="beat-filter">
                    <option value="full">Full Range</option>
                    <option value="bass" selected>Bass (0-150Hz)</option>
                    <option value="mids">Mids (150-2kHz)</option>
                  </select>
                </label>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Hold-off (ms)
                  <input id="beat-holdoff" type="number" min="50" max="1000" step="10" value="200" />
                </label>
              </div>
            </div>
            <div class="panel-block">
              <h3>Project</h3>
              <div class="scene-row">
                <button id="btn-save">Save Project</button>
                <button id="btn-save-perf">Save Performance</button>
                <button id="btn-load">Load</button>
              </div>
              <label class="scene-label">
                Template
                <select id="template-select"></select>
              </label>
              <button id="btn-apply-template">Apply Template</button>
            </div>
            <div class="panel-block">
              <h3>Clock</h3>
              <label class="scene-label">
                BPM Source
                <select id="bpm-source">
                  <option value="manual">Manual</option>
                  <option value="auto">Auto Detect</option>
                  <option value="network">Prolink Connect</option>
                </select>
              </label>
              <label class="scene-label">
                BPM Range
                <select id="bpm-range">
                  <option value="40-120">40 - 120</option>
                  <option value="80-150">80 - 150</option>
                  <option value="100-200">100 - 200</option>
                  <option value="custom" selected>Custom</option>
                </select>
              </label>
              <div class="scene-row">
                <label class="scene-inline">
                  Min
                  <input id="bpm-min" type="number" min="40" max="300" step="1" value="80" />
                </label>
                <label class="scene-inline">
                  Max
                  <input id="bpm-max" type="number" min="40" max="300" step="1" value="150" />
                </label>
              </div>
              <label class="scene-label">
                Manual BPM
                <input id="tempo-input" type="number" min="40" max="240" step="1" value="120" />
              </label>
              <div class="scene-row">
                <label class="scene-inline">
                  Network Interface
                  <select id="bpm-interface"></select>
                </label>
                <button id="bpm-network-toggle">Start Network</button>
              </div>
            </div>
          </div>
        </section>
        <section class="center-panel">
                    <div id="mode-mapping-center" class="mode-pane hidden">
                      <h2>Mapping</h2>
                      <div class="panel-block">
                        <h3>Mod Matrix</h3>
                        <div class="matrix-header">
                          <button id="mod-matrix-add">Add Mod</button>
                        </div>
                        <div id="mod-matrix-list" class="matrix-list"></div>
                      </div>
                      <div class="panel-block">
                        <h3>MIDI Mapping</h3>
                        <div class="matrix-header">
                          <button id="midi-map-add">Add Mapping</button>
                        </div>
                        <div id="midi-map-list" class="matrix-list"></div>
                      </div>
                    </div>
                    <div id="mapping-hud" class="mapping-hud hidden">
                      <div class="mapping-hud-icon">⚡</div>
                      <div class="mapping-hud-content">
                        <div id="mapping-hud-title" class="mapping-hud-title">Mapping Mode</div>
                        <div id="mapping-hud-target" class="mapping-hud-target">Select a target...</div>
                      </div>
                      <button id="mapping-hud-cancel" class="mapping-hud-cancel">✕</button>
                    </div>
                    <canvas id="gl-canvas" width="1280" height="720"></canvas>
          <canvas id="visualizer-canvas" width="1280" height="720"></canvas>
          <div id="fade-overlay" class="fade-overlay hidden"></div>
          <div id="quantize-hud" class="quantize-hud hidden">Switching in --</div>
          <div id="safe-mode-banner" class="safe-mode hidden">Safe mode: --</div>
        </section>
<section class="right-panel">
          <div class="macro-hero">
            <div class="macro-hero-header">
              <h2>Scene Macros</h2>
              <div class="macro-hero-subtitle">Energy · Motion · Color · Density</div>
            </div>
            <div class="macro-hero-grid">
              <label class="macro-hero-item">
                <span>Energy</span>
                <input id="macro-energy" type="range" min="0" max="1" step="0.01" value="0.5" />
                <strong id="macro-energy-value">0.50</strong>
              </label>
              <label class="macro-hero-item">
                <span>Motion</span>
                <input id="macro-motion" type="range" min="0" max="1" step="0.01" value="0.5" />
                <strong id="macro-motion-value">0.50</strong>
              </label>
              <label class="macro-hero-item">
                <span>Color</span>
                <input id="macro-color" type="range" min="0" max="1" step="0.01" value="0.5" />
                <strong id="macro-color-value">0.50</strong>
              </label>
              <label class="macro-hero-item">
                <span>Density</span>
                <input id="macro-density" type="range" min="0" max="1" step="0.01" value="0.5" />
                <strong id="macro-density-value">0.50</strong>
              </label>
            </div>
          </div>
          <div id="matrix-controls" class="matrix-controls hidden">
            <h2>Matrix Modulators</h2>
            <div class="panel-block">
              <div class="matrix-tabs">
                <button type="button" class="matrix-tab active" data-matrix-tab="lfos">LFOs</button>
                <button type="button" class="matrix-tab" data-matrix-tab="envelopes">Envelopes</button>
                <button type="button" class="matrix-tab" data-matrix-tab="sh">Sample &amp; Hold</button>
              </div>
              <div class="matrix-tab-panels">
                <div class="matrix-tab-panel active" data-matrix-panel="lfos">
                  <div class="mod-section">
                    <div class="mod-title">LFOs</div>
                    <div id="lfo-list" class="mod-list"></div>
                  </div>
                </div>
                <div class="matrix-tab-panel" data-matrix-panel="envelopes">
                  <div class="mod-section">
                    <div class="mod-title">Envelopes</div>
                    <div id="env-list" class="mod-list"></div>
                  </div>
                </div>
                <div class="matrix-tab-panel" data-matrix-panel="sh">
                  <div class="mod-section">
                    <div class="mod-title">Sample &amp; Hold</div>
                    <div id="sh-list" class="mod-list"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="mode-performance-right" class="mode-pane">
            <h2>Macros</h2>
            <div id="macro-list" class="macro-list"></div>
            <div class="panel-block">
              <h3>Preset Playlist</h3>
              <div class="scene-row">
                <button id="playlist-add" type="button">Add Selected</button>
                <button id="playlist-remove" type="button">Remove</button>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Slot Sec
                  <input id="playlist-slot-seconds" type="number" min="2" max="300" step="1" value="16" />
                </label>
                <label class="scene-inline">
                  Fade Sec
                  <input id="playlist-fade-seconds" type="number" min="0" max="30" step="0.5" value="2" />
                </label>
              </div>
              <div class="scene-row">
                <button id="playlist-play" type="button">Play</button>
                <button id="playlist-stop" type="button">Stop</button>
              </div>
              <div id="playlist-list" class="marker-list"></div>
            </div>
          </div>

          <div id="mode-scene-right" class="mode-pane hidden">
            <h2>Scene Inspector</h2>
            <div class="panel-block">
              <h3>Style Presets</h3>
              <label class="scene-label">
                Preset
                <select id="style-select"></select>
              </label>
              <label class="scene-label">
                Transition Type
                <select id="scene-transition-type">
                  <option value="fade">Fade</option>
                  <option value="crossfade">Crossfade</option>
                  <option value="warp">Warp</option>
                  <option value="glitch">Glitch</option>
                  <option value="dissolve">Dissolve</option>
                </select>
              </label>
              <div class="scene-row">
                <label class="scene-inline">
                  Contrast
                  <input
                    id="style-contrast"
                    type="range"
                    min="0.6"
                    max="1.6"
                    step="0.05"
                    value="1"
                    data-learn-target="style.contrast"
                    data-learn-label="Style Contrast"
                  />
                </label>
                <label class="scene-inline">
                  Saturation
                  <input
                    id="style-saturation"
                    type="range"
                    min="0.6"
                    max="1.8"
                    step="0.05"
                    value="1"
                    data-learn-target="style.saturation"
                    data-learn-label="Style Saturation"
                  />
                </label>
                <label class="scene-inline">
                  Palette Shift
                  <input
                    id="style-shift"
                    type="range"
                    min="-0.5"
                    max="0.5"
                    step="0.02"
                    value="0"
                    data-learn-target="style.paletteShift"
                    data-learn-label="Palette Shift"
                  />
                </label>
              </div>
            </div>
            <div class="panel-block">
              <h3>Visualizers</h3>
              <label class="scene-label scene-label-inline">
                <input type="checkbox" id="visualizer-enabled" /> Enabled
              </label>
              <label class="scene-label">
                Mode
                <select id="visualizer-mode">
                  <option value="off">Off</option>
                  <option value="spectrum">Spectrum</option>
                  <option value="waveform">Waveform</option>
                  <option value="oscilloscope">Oscilloscope</option>
                </select>
              </label>
              <label class="scene-label">
                Opacity
                <input id="visualizer-opacity" type="range" min="0" max="1" step="0.05" value="0.8" />
              </label>
              <label class="scene-label">
                <input type="checkbox" id="visualizer-macro-enabled" /> Map opacity to macro
              </label>
              <label class="scene-label">
                Macro
                <select id="visualizer-macro-select">
                  <option value="1">Macro 1</option>
                  <option value="2">Macro 2</option>
                  <option value="3">Macro 3</option>
                  <option value="4">Macro 4</option>
                  <option value="5">Macro 5</option>
                  <option value="6">Macro 6</option>
                  <option value="7">Macro 7</option>
                  <option value="8" selected>Macro 8</option>
                </select>
              </label>
              <div class="output-hint">Overlays on top of the main render.</div>
            </div>
            <div class="panel-block">
              <h3>Capture</h3>
              <div class="scene-row">
                <button id="capture-screenshot">Screenshot</button>
                <button id="capture-record-toggle">Start Recording</button>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Format
                  <select id="capture-format">
                    <option value="webm">WebM</option>
                    <option value="mp4">MP4 (ffmpeg)</option>
                  </select>
                </label>
                <label class="scene-inline">
                  FPS
                  <select id="capture-fps">
                    <option value="24">24</option>
                    <option value="30" selected>30</option>
                    <option value="60">60</option>
                  </select>
                </label>
              </div>
              <div id="capture-status" class="output-hint">Idle</div>
            </div>
            <div class="panel-block">
              <h3>Automation Clips</h3>
              <div class="scene-row">
                <input id="marker-label" type="text" placeholder="Clip label" />
                <button id="marker-add">Add Marker</button>
              </div>
              <div id="marker-list" class="marker-list"></div>
            </div>
          </div>

          <div id="mode-mixer-right" class="mode-pane hidden">
            <h2>Mixer Controls</h2>
            <div class="panel-block">
              <h3>Role Weights</h3>
              <!-- Shared with Performance tab for consistency -->
              <div id="mixer-role-weights-anchor"></div>
            </div>
          </div>

          
          
          <div id="mode-design-right" class="mode-pane hidden">
            <h2>Design</h2>
            <div class="panel-block">
              <h3>Assets</h3>
              <div class="scene-row">
                <button id="asset-import">Import Texture / Shader</button>
                <select id="asset-kind">
                  <option value="texture">Texture</option>
                  <option value="shader">Shader</option>
                </select>
                <button id="asset-import-video">Import Video</button>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Color Space
                  <select id="asset-color-space">
                    <option value="srgb" selected>sRGB</option>
                    <option value="linear">Linear</option>
                  </select>
                </label>
                <label class="scene-inline">
                  Texture Sampling
                  <select id="asset-texture-sampling">
                    <option value="linear" selected>Linear</option>
                    <option value="nearest">Nearest</option>
                  </select>
                </label>
                <label class="scene-inline">
                  Generate mipmaps
                  <input id="asset-generate-mipmaps" type="checkbox" />
                </label>
              </div>
              <div class="scene-row">
                <label class="scene-inline">
                  Loop
                  <input id="asset-video-loop" type="checkbox" />
                </label>
                <label class="scene-inline">
                  Reverse
                  <input id="asset-video-reverse" type="checkbox" />
                </label>
                <label class="scene-inline">
                  Playback Rate
                  <input id="asset-video-rate" type="number" min="0.1" max="4" step="0.1" value="1" />
                </label>
                <label class="scene-inline">
                  Frame Blend
                  <input id="asset-video-frameblend" type="range" min="0" max="1" step="0.1" value="0" />
                </label>
              </div>
              <div class="scene-row">
                <button id="asset-live-webcam">Start Webcam</button>
                <button id="asset-live-screen">Screen Capture</button>
              </div>
              <div class="scene-row">
                <input id="asset-text-input" type="text" placeholder="Caption / lyrics" />
                <input id="asset-font-input" type="text" placeholder="Font (e.g. 48px Arial)" />
                <button id="asset-text-add">Add Text Layer</button>
              </div>
              <div class="scene-row">
                <input id="asset-tags" type="text" placeholder="tags (comma separated)" />
              </div>
              <div id="asset-list" class="marker-list"></div>
            </div>
            <div class="panel-block">
              <h3>Render Graph</h3>
              <div id="render-graph" class="render-graph">
                Graph view placeholder - full routing UI lives here.
              </div>
            </div>
            <div class="panel-block">
              <h3>Shader Editor</h3>
              <label class="scene-label">
                Target
                <select id="shader-target">
                  <option value="layer-plasma">Shader Plasma</option>
                  <option value="layer-spectrum">Spectrum Bars</option>
                </select>
              </label>
              <textarea id="shader-editor" class="shader-editor" rows="8" placeholder="Paste GLSL here (define vec3 customPlasma(vec2 uv, float t))..."></textarea>
              <div class="scene-row">
                <button id="shader-apply" type="button">Apply Draft</button>
                <button id="shader-save" type="button">Save Draft</button>
              </div>
              <div id="shader-status" class="output-hint">Drafts compile in-session. Save stores a shader asset in the project.</div>
            </div>
            <div class="panel-block">
              <h3>Parameter Search</h3>
              <input id="design-search" class="search-input" type="text" placeholder="Search parameters, nodes, targets..." />
            </div>
            <div class="panel-block">
              <h3>Pad Mapping</h3>
              <div class="bank-row" id="pad-map-bank">
                <button type="button" data-bank="A" class="bank-button active">A</button>
                <button type="button" data-bank="B" class="bank-button">B</button>
                <button type="button" data-bank="C" class="bank-button">C</button>
                <button type="button" data-bank="D" class="bank-button">D</button>
              </div>
              <div id="pad-map-grid" class="pad-map-grid"></div>
              <div class="pad-hint">Click a pad to cycle its action. Bank buttons switch pages.</div>
            </div>
          </div>

          <div id="mode-system-right" class="mode-pane hidden">
            <h2>System</h2>
            <div class="panel-block">
              <h3>Latency Dashboard</h3>
              <div id="latency-summary" class="output-hint">Audio: -- | Output: -- | MIDI: --</div>
            </div>
            <div class="panel-block">
              <h3>Performance Guardrails</h3>
              <div id="guardrail-status" class="output-hint">Guardrails: OK</div>
              <div id="guardrail-hint" class="output-hint">Output scale: 100%</div>
            </div>
            <div class="panel-block">
              <h3>Diagnostics</h3>
              <div id="diag-fps">FPS: --</div>
              <div id="diag-gpu">GPU: WebGL2</div>
              <div id="diag-latency">Audio Latency: --</div>
              <div id="diag-output-latency">Output Latency: --</div>
              <div id="diag-midi-latency">MIDI Latency: --</div>
              <div id="diag-watchdog">Watchdog: OK</div>
              <div id="diag-webgl" class="diag-webgl"></div>
              <button id="diag-webgl-copy" type="button">Copy WebGL Diagnostics</button>
            </div>
            <div class="panel-block">
              <h3>Output</h3>
              <div class="output-row">
                <button id="output-toggle">Open Output</button>
                <label class="output-toggle">
                  <input type="checkbox" id="output-fullscreen" />
                  Fullscreen
                </label>
              </div>
              <label class="output-label">
                Resolution Scale
                <select id="output-scale">
                  <option value="1">100%</option>
                  <option value="0.75">75%</option>
                  <option value="0.5">50%</option>
                  <option value="0.25">25%</option>
                </select>
              </label>
              <div id="output-resolution" class="output-hint">Output: 1280 x 720</div>
            </div>
            <div class="panel-block">
              <h3>Plugins</h3>
              <div class="scene-row">
                <button id="plugin-import">Import Plugin</button>
              </div>
              <div id="plugin-list" class="marker-list"></div>
            </div>
            <div class="panel-block">
              <h3>Project Diff/Merge</h3>
              <div class="scene-row">
                <button id="diff-use-current">Use Current as Base</button>
                <button id="diff-load-incoming">Load Incoming</button>
                <button id="diff-apply">Apply Merge</button>
              </div>
              <div id="diff-status" class="output-hint">No incoming project loaded.</div>
              <div id="diff-sections" class="diff-sections"></div>
            </div>
          </div>
        </section>
</main>

      <footer class="status-bar">
        <div id="status">Ready</div>
        <div class="shortcuts">Space: pause | F: fullscreen | R: record | P: screenshot | Ctrl+S save | Ctrl+O open</div>
      </footer>
    </div>

    <div id="webcam-picker" class="modal-overlay hidden">
      <div class="modal-card">
        <h3>Select Webcam</h3>
        <label class="scene-label">
          Camera
          <select id="webcam-picker-select"></select>
        </label>
        <label class="scene-inline modal-checkbox">
          Remember this camera
          <input id="webcam-picker-remember" type="checkbox" checked />
        </label>
        <div class="scene-row modal-actions">
          <button id="webcam-picker-cancel" type="button">Cancel</button>
          <button id="webcam-picker-confirm" type="button">Use Camera</button>
        </div>
      </div>
    </div>

    <script src="index.js"></script>
  </body>
</html>
